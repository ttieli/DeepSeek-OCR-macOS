# 🔍 问题诊断与解决

## ❌ 核心问题

### 问题：环境变量设置时机错误

虽然在 `run_ocr_test.py` 中设置了：
```python
os.environ["PYTORCH_ENABLE_MPS_FALLBACK"] = "1"
```

但这个设置**太晚了**！因为：
1. PyTorch 在导入时就会初始化 MPS 后端
2. 在 Python 代码中设置环境变量对已加载的模块无效
3. 必须在 Python 进程启动**之前**设置环境变量

### 错误的调用链

```
bash test.sh
  → python run_ocr_test.py  # Python 启动
    → import torch  # PyTorch 初始化，读取环境变量
      → os.environ["..."] = "1"  # 太晚了！PyTorch 已经初始化完成
```

## ✅ 解决方案

### 修复：在 shell 脚本中设置环境变量

修改后的 `test.sh`：

```bash
# 设置 MPS fallback 环境变量（必须在 Python 启动前设置）
export PYTORCH_ENABLE_MPS_FALLBACK=1
export PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0

# 然后启动 Python
python run_ocr_test.py
```

### 正确的调用链

```
bash test.sh
  → export PYTORCH_ENABLE_MPS_FALLBACK=1  # 设置环境变量
  → python run_ocr_test.py  # Python 启动
    → import torch  # PyTorch 初始化，读取到正确的环境变量 ✅
```

## 🚀 现在怎么做

### 选项 1：运行更新后的测试脚本

```bash
cd "/Users/tieli/Library/Mobile Documents/com~apple~CloudDocs/Project/DeepSeek_OCR_for_MacOS"
bash test.sh
```

### 选项 2：使用一键运行脚本（推荐）

```bash
cd "/Users/tieli/Library/Mobile Documents/com~apple~CloudDocs/Project/DeepSeek_OCR_for_MacOS"
bash 一键运行.sh
```

这个脚本会：
1. 自动运行 `fix_mps_support.py`（修复 CUDA）
2. 自动运行 `test.sh`（带正确的环境变量）

### 选项 3：手动设置环境变量

```bash
# 激活 conda 环境
source ~/miniforge3/etc/profile.d/conda.sh
conda activate deepseek-ocr

# 设置环境变量
export PYTORCH_ENABLE_MPS_FALLBACK=1
export PYTORCH_MPS_HIGH_WATERMARK_RATIO=0.0

# 运行测试
cd "/Users/tieli/Library/Mobile Documents/com~apple~CloudDocs/Project/DeepSeek_OCR_for_MacOS"
python run_ocr_test.py
```

## 📊 预期结果

这次应该会：
1. ✅ 不再报 `PYTORCH_ENABLE_MPS_FALLBACK` 错误
2. ✅ 遇到不支持的 MPS 操作时，自动 fallback 到 CPU
3. ✅ OCR 识别成功完成
4. ✅ 结果保存到 `ocr_output/` 目录

## 💡 为什么会有这个问题？

这是一个常见的陷阱：

- **环境变量的作用时机**：操作系统级别的环境变量必须在程序启动前设置
- **Python 中设置环境变量**：只对该 Python 进程中**未来**启动的子进程有效
- **PyTorch 的初始化**：在 `import torch` 时就读取环境变量并初始化后端

## 🔧 已修改的文件

1. **`test.sh`** - 添加了 `export` 语句
2. **`一键运行.sh`** - 新建，包含完整流程

## 🎯 下一步

在终端运行：

```bash
bash test.sh
```

或者：

```bash
bash 一键运行.sh
```

应该就能成功了！ 🎉
