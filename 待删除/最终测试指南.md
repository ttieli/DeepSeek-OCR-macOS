# 🎯 DeepSeek-OCR 最终测试指南

## ✅ 已完成的修复

### 1. CUDA 兼容性问题 ✅
- **问题**：代码硬编码 `.cuda()`，macOS 不支持 CUDA
- **解决**：已自动替换为 `.to(self.device)`（12处修改）
- **状态**：✅ 已修复

### 2. MPS 操作不支持问题 ✅
- **问题**：`aten::_upsample_bicubic2d_aa.out` 操作 MPS 不支持
- **解决**：添加 `PYTORCH_ENABLE_MPS_FALLBACK=1` 环境变量
- **状态**：✅ 已修复

## 🚀 现在开始测试

### 运行测试命令

```bash
cd "/Users/tieli/Library/Mobile Documents/com~apple~CloudDocs/Project/DeepSeek_OCR_for_MacOS"
bash test.sh
```

### 预期行为

测试会：
1. ✅ 激活 conda 环境
2. ✅ 加载模型到 MPS 设备
3. ⚠️ 对于不支持的 MPS 操作，自动 fallback 到 CPU
4. ✅ 完成 OCR 识别
5. ✅ 保存结果到 `ocr_output/` 目录

### 性能说明

由于启用了 MPS fallback：
- **大部分操作**：使用 MPS（GPU 加速）- 快速
- **特定操作**（如 bicubic 插值）：使用 CPU - 稍慢
- **整体速度**：混合模式，比纯 CPU 快，比纯 MPS 慢一些

**预计时间**：
- 首次运行（包含模型下载）：10-20 分钟
- 后续运行（仅识别）：每张图片 2-5 分钟

## 📊 查看结果

测试完成后，结果在：

```bash
# 查看输出目录
ls -la ocr_output/

# 打开结果文件
open ocr_output/[图片名称]/[图片名称]_result.md
```

## ⚠️ 如果还有问题

### 问题 A：仍然报 CUDA 错误

**原因**：可能需要重新下载模型文件

**解决**：
```bash
# 删除缓存
rm -rf ~/.cache/huggingface/modules/transformers_modules/deepseek-ai/DeepSeek-OCR

# 重新运行测试（会重新下载）
bash test.sh

# 再次运行修复
python3 fix_mps_support.py

# 再次测试
bash test.sh
```

### 问题 B：MPS 内存不足

**解决**：强制使用 CPU 模式

编辑 `run_ocr_test.py`，修改第 28 行：
```python
# 修改前
device = "mps"

# 修改后
device = "cpu"  # 强制 CPU
```

### 问题 C：其他错误

1. 查看完整错误信息
2. 检查可用内存（至少 8GB 空闲）
3. 尝试降低分辨率参数

## 📖 参考文档

你的 `output/` 目录中有一份参考文档：
```
2025-10-23-175813 - MacOS ARM系统下原生部署指南：DeepSeek-OCR实战详解及使用教程 - 全栈开发.md
```

该文档包含：
- 完整的部署流程
- 性能优化技巧
- 常见问题解决
- 进阶应用场景

## 🎉 测试步骤总结

```bash
# 1. 进入项目目录
cd "/Users/tieli/Library/Mobile Documents/com~apple~CloudDocs/Project/DeepSeek_OCR_for_MacOS"

# 2. 运行测试（已包含所有修复）
bash test.sh

# 3. 等待完成（耐心等待，不要中断）

# 4. 查看结果
open ocr_output/
```

## 💡 关键提示

1. **首次运行时间长**：下载模型约 10GB，需要良好网络
2. **MPS fallback 是正常的**：看到 fallback 警告不要慌，这是预期行为
3. **内存监控**：运行时监控内存使用，确保有足够空闲空间
4. **不要中断**：OCR 过程中不要强制退出，否则可能需要重新开始

## 🔧 已修改的文件

1. **`run_ocr_test.py`**
   - 添加了 `PYTORCH_ENABLE_MPS_FALLBACK=1`

2. **`~/.cache/.../modeling_deepseekocr.py`**
   - 替换了 12 处 `.cuda()` 调用
   - 添加了 `device` 属性

3. **备份文件**
   - `modeling_deepseekocr.py.backup` - 原始文件备份

---

**现在运行 `bash test.sh` 开始测试！** 🚀

有任何问题随时告诉我。
